package model

import (
	"fmt"
	"time"
)

// EPSSScore represents EPSS exploit prediction data
type EPSSScore struct {
	Score      float64 // 0-1 probability of exploitation
	Percentile float64 // 0-1 ranking against all CVEs
}

// CVSSScore represents CVSS vulnerability score data
type CVSSScore struct {
	Version  string  // e.g., "3.1", "3.0", "2.0"
	Score    float64 // 0-10 base score
	Severity string  // CRITICAL, HIGH, MEDIUM, LOW
	Vector   string  // CVSS vector string
	Source   string  // e.g., "nvd@nist.gov", "security-advisories@github.com"
	Type     string  // "Primary" or "Secondary"
}

// CVSSData holds all CVSS assessments for a vulnerability
type CVSSData struct {
	Primary   *CVSSScore  // NVD's primary assessment
	Secondary []CVSSScore // CNA/vendor assessments
}

// Vulnerability represents a CISA KEV entry
type Vulnerability struct {
	CVEID             string
	VendorProject     string
	Product           string
	VulnerabilityName string
	DateAdded         time.Time
	DueDate           time.Time
	ShortDescription  string
	RequiredAction    string
	RansomwareUse     bool
	Notes             string
	CWEs              []string
	EPSS              EPSSScore
}

// NVDURL returns the NVD URL for this CVE
func (v Vulnerability) NVDURL() string {
	return "https://nvd.nist.gov/vuln/detail/" + v.CVEID
}

// IsOverdue returns true if the due date has passed
func (v Vulnerability) IsOverdue() bool {
	if v.DueDate.IsZero() {
		return false
	}
	return time.Now().After(v.DueDate)
}

// DaysUntilDue returns the number of days until the due date
// Negative values indicate overdue days
func (v Vulnerability) DaysUntilDue() int {
	if v.DueDate.IsZero() {
		return 0
	}
	duration := time.Until(v.DueDate)
	return int(duration.Hours() / 24)
}

// DueDateStatus returns a human-readable due date status
func (v Vulnerability) DueDateStatus() string {
	if v.DueDate.IsZero() {
		return "No due date"
	}
	days := v.DaysUntilDue()
	if days < 0 {
		return fmt.Sprintf("OVERDUE by %d days", -days)
	} else if days == 0 {
		return "DUE TODAY"
	} else if days == 1 {
		return "Due tomorrow"
	}
	return fmt.Sprintf("%d days left", days)
}

// EPSSPercent returns EPSS score as a percentage string
func (v Vulnerability) EPSSPercent() string {
	if v.EPSS.Score == 0 {
		return ""
	}
	return fmt.Sprintf("%.1f%%", v.EPSS.Score*100)
}

// EPSSPercentileStr returns EPSS percentile as a readable string
func (v Vulnerability) EPSSPercentileStr() string {
	if v.EPSS.Percentile == 0 {
		return ""
	}
	pct := v.EPSS.Percentile * 100
	if pct >= 95 {
		return fmt.Sprintf("Top %.0f%%", 100-pct)
	}
	return fmt.Sprintf("%.0f%% percentile", pct)
}
